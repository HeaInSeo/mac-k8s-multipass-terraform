name: selfhosted multipass smoke

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

# 같은 러너에서 multipass 작업을 동시에 돌리면 VM/네트워크가 꼬일 수 있어서 1개로 잠금
concurrency:
  group: rocky-baremetal-multipass
  cancel-in-progress: false

jobs:
  smoke:
    runs-on: [self-hosted, Linux, X64, multipass]

    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show runner context
        run: |
          set -euo pipefail
          whoami
          uname -a
          echo "PATH=$PATH"
          id
          sudo -n true || echo "WARN: passwordless sudo not configured"
      
      - name: Multipass service check
        run: |
          set -euo pipefail
          sudo -n /usr/bin/systemctl is-active snap.multipass.multipassd
          sudo -n /snap/bin/multipass version

      - name: Multipass sanity
        run: |
          set -euo pipefail
          sudo -n /snap/bin/multipass version
          sudo -n /snap/bin/multipass list || true

      # 실패하든 성공하든 테스트 VM만 정리
      - name: Cleanup old test VMs (best effort)
        if: always()
        run: |
          set +e
          for vm in $(sudo -n /snap/bin/multipass list | awk 'NR>1 {print $1}' | grep '^gha-' || true); do
            sudo -n /snap/bin/multipass stop "$vm" || true
            sudo -n /snap/bin/multipass delete "$vm" || true
          done
          sudo -n /snap/bin/multipass purge
          sudo -n /snap/bin/multipass list || true

      - name: Launch test VM
        run: |
          set -euo pipefail

          # 혹시 이전 찌꺼기 있으면 제거(안전)
          sudo -n /snap/bin/multipass delete gha-smoke >/dev/null 2>&1 || true
          sudo -n /snap/bin/multipass purge || true
          
          sudo -n /snap/bin/multipass launch \
            --name gha-smoke \
            --cpus 2 \
            --memory 2G \
            --disk 10G

          sudo -n /snap/bin/multipass list
          sudo -n /snap/bin/multipass info gha-smoke || true
          sudo -n /snap/bin/multipass exec gha-smoke -- uname -a
          sudo -n /snap/bin/multipass exec gha-smoke -- bash -lc 'cloud-init status --wait || true'

      - name: Destroy test VM
        if: always()
        run: |
          set +e
          sudo -n /snap/bin/multipass stop gha-smoke
          sudo -n /snap/bin/multipass delete gha-smoke
          sudo -n /snap/bin/multipass purge
          sudo -n /snap/bin/multipass list || true

      - name: Final cleanup (best effort)
        if: always()
        run: |
          set +e
          for vm in $(sudo -n /snap/bin/multipass list | awk 'NR>1 {print $1}' | grep '^gha-' || true); do
            sudo -n /snap/bin/multipass stop "$vm" || true
            sudo -n /snap/bin/multipass delete "$vm" || true
          done
          sudo -n /snap/bin/multipass purge
          sudo -n /snap/bin/multipass list || true
