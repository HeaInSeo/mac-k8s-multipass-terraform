name: selfhosted multipass smoke

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

# 같은 러너에서 multipass 작업을 동시에 돌리면 VM/네트워크가 꼬일 수 있어서 1개로 잠금
concurrency:
  group: rocky-baremetal-multipass
  cancel-in-progress: false

jobs:
  smoke:
    runs-on: [self-hosted, Linux, X64, multipass]

    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show runner context
        run: |
          set -euo pipefail
          whoami
          uname -a
          echo "PATH=$PATH"
          id
          sudo -n true

      - name: Multipass sanity
        run: |
          set -euo pipefail
          sudo /snap/bin/multipass version
          sudo /snap/bin/multipass list || true

      # 실패하든 성공하든 항상 VM 정리
      - name: Cleanup old test VMs (best effort)
        if: always()
        run: |
          set +e
          sudo /snap/bin/multipass stop --all
          sudo /snap/bin/multipass delete --all
          sudo /snap/bin/multipass purge
          sudo /snap/bin/multipass list || true

      - name: Launch test VM
        run: |
          set -euo pipefail
          sudo /snap/bin/multipass launch \
            --name gha-smoke \
            --cpus 2 \
            --memory 2G \
            --disk 10G
          sudo /snap/bin/multipass list
          sudo /snap/bin/multipass exec gha-smoke -- uname -a
          sudo /snap/bin/multipass exec gha-smoke -- bash -lc 'cloud-init status --wait || true'

      - name: Destroy test VM
        if: always()
        run: |
          set +e
          sudo /snap/bin/multipass stop gha-smoke
          sudo /snap/bin/multipass delete gha-smoke
          sudo /snap/bin/multipass purge
          sudo /snap/bin/multipass list || true
